<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunnel Sessions - Host Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="logo.svg" alt="Tunnel Sessions Logo" class="logo">
            <h1>Host Dashboard</h1>
            <p class="tagline">Manage Your Sessions</p>
        </header>

        <!-- Login Screen -->
        <main id="login-screen" class="host-main">
            <section class="card login-card">
                <h2>Host Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <p id="login-error" class="error-message hidden">Invalid username or password</p>
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                </form>
            </section>
        </main>

        <!-- Setup Screen (First Time) -->
        <main id="setup-screen" class="host-main hidden">
            <section class="card login-card">
                <h2>Create Admin Account</h2>
                <p class="setup-intro">Set up your host login to manage sessions.</p>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="setupUsername">Username</label>
                        <input type="text" id="setupUsername" required minlength="3" autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label for="setupPassword">Password</label>
                        <input type="password" id="setupPassword" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="setupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="setupPasswordConfirm" required minlength="6" autocomplete="new-password">
                    </div>
                    <p id="setup-error" class="error-message hidden"></p>
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                </form>
            </section>
        </main>

        <!-- Dashboard (After Login) -->
        <main id="dashboard-screen" class="host-main hidden">
            <!-- Logout Bar -->
            <div class="logout-bar">
                <span id="welcome-user"></span>
                <button class="btn btn-small btn-outline" onclick="handleLogout()">Logout</button>
            </div>

            <!-- Create Session Section -->
            <section class="card">
                <h2>Create New Session</h2>
                <form id="create-session-form">
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <select id="sessionType" required>
                            <option value="">Select a session type</option>
                            <option value="ShredClub">ShredClub</option>
                            <option value="Rookie Scrambles">Rookie Scrambles</option>
                            <option value="Advanced Scrambles">Advanced Scrambles</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sessionDay">Day of Week</label>
                            <select id="sessionDay" required>
                                <option value="">Select a day</option>
                                <option value="0">Sunday</option>
                                <option value="1">Monday</option>
                                <option value="2">Tuesday</option>
                                <option value="3">Wednesday</option>
                                <option value="4">Thursday</option>
                                <option value="5">Friday</option>
                                <option value="6">Saturday</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sessionTime">Time</label>
                            <input type="time" id="sessionTime" value="19:00" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sessionDuration">Duration (minutes)</label>
                            <input type="number" id="sessionDuration" value="60" min="15" max="180" required>
                        </div>
                        <div class="form-group">
                            <label for="sessionCapacity">Capacity (people)</label>
                            <input type="number" id="sessionCapacity" value="4" min="1" max="20" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="repeatWeeks">Repeat for X weeks</label>
                            <input type="number" id="repeatWeeks" value="1" min="1" max="52" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Session(s)</button>
                </form>
            </section>

            <!-- Manage Sessions Section -->
            <section class="card">
                <h2>Manage Sessions</h2>
                <div id="host-sessions-list" class="host-sessions"></div>
                <div id="no-host-sessions" class="message hidden">
                    <p>No sessions created yet. Create your first session above!</p>
                </div>
            </section>

            <!-- Add Person Modal -->
            <div id="add-person-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h3>Add Person to Session</h3>
                    <div id="add-session-details"></div>
                    <form id="add-person-form">
                        <div class="form-group">
                            <label for="addFirstName">First Name</label>
                            <input type="text" id="addFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="addLastName">Last Name</label>
                            <input type="text" id="addLastName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Person</button>
                    </form>
                </div>
            </div>
        </main>

        <footer>
            <a href="index.html" class="host-link">Back to Booking Page</a>
        </footer>
    </div>

    <script src="app.js"></script>
    <script>
        // Screen management
        const loginScreen = document.getElementById('login-screen');
        const setupScreen = document.getElementById('setup-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');

        function showScreen(screen) {
            loginScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        // Initialize - check auth state
        document.addEventListener('DOMContentLoaded', () => {
            if (!adminExists()) {
                // First time - show setup
                showScreen(setupScreen);
            } else if (isLoggedIn()) {
                // Already logged in
                showDashboard();
            } else {
                // Show login
                showScreen(loginScreen);
            }
        });

        // Setup form
        document.getElementById('setup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('setupUsername').value.trim();
            const password = document.getElementById('setupPassword').value;
            const confirmPassword = document.getElementById('setupPasswordConfirm').value;
            const errorEl = document.getElementById('setup-error');

            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            await createAdmin(username, password);
            setLoggedIn();
            showDashboard();
        });

        // Login form
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('login-error');

            const valid = await verifyAdmin(username, password);

            if (valid) {
                errorEl.classList.add('hidden');
                setLoggedIn();
                showDashboard();
            } else {
                errorEl.classList.remove('hidden');
            }
        });

        // Logout
        function handleLogout() {
            logout();
            showScreen(loginScreen);
            document.getElementById('login-form').reset();
        }

        // Show dashboard
        function showDashboard() {
            const admin = getAdmin();
            document.getElementById('welcome-user').textContent = `Welcome, ${admin.username}`;
            showScreen(dashboardScreen);
            loadHostSessions();
        }

        function loadHostSessions() {
            const sessions = getSessions();
            const container = document.getElementById('host-sessions-list');
            const noSessionsMsg = document.getElementById('no-host-sessions');

            container.innerHTML = '';

            if (sessions.length === 0) {
                noSessionsMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }

            noSessionsMsg.classList.add('hidden');
            container.classList.remove('hidden');

            // Sort by date
            sessions.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            sessions.forEach(session => {
                const card = createHostSessionCard(session);
                container.appendChild(card);
            });
        }

        function createHostSessionCard(session) {
            const card = document.createElement('div');
            card.className = 'host-session-card';

            const date = new Date(session.date + 'T' + session.time);
            const now = new Date();
            const isPast = date < now;

            if (isPast) {
                card.classList.add('past');
            }

            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            let bookingsHtml = '';
            if (session.bookings.length > 0) {
                bookingsHtml = '<ul class="bookings-list">';
                session.bookings.forEach((booking, index) => {
                    bookingsHtml += `
                        <li>
                            <span>${booking.firstName} ${booking.lastName}</span>
                            <button class="btn-remove" onclick="removeBooking('${session.id}', ${index})" title="Remove">&#10005;</button>
                        </li>
                    `;
                });
                bookingsHtml += '</ul>';
            } else {
                bookingsHtml = '<p class="no-bookings">No bookings yet</p>';
            }

            card.innerHTML = `
                <div class="host-session-header">
                    <div>
                        <span class="session-type-badge">${session.sessionType || 'Session'}</span>
                        <h3>${dateStr}</h3>
                        <p>${timeStr} - ${session.duration} min | ${session.bookings.length}/${session.capacity} booked</p>
                    </div>
                    <div class="session-actions">
                        ${!isPast ? `<button class="btn btn-small" onclick="openAddPersonModal('${session.id}')">Add Person</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deleteSession('${session.id}')">Delete</button>
                    </div>
                </div>
                <div class="bookings-container">
                    <h4>Bookings:</h4>
                    ${bookingsHtml}
                </div>
            `;

            return card;
        }

        // Create Session Form
        document.getElementById('create-session-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const sessionType = document.getElementById('sessionType').value;
            const dayOfWeek = parseInt(document.getElementById('sessionDay').value);
            const time = document.getElementById('sessionTime').value;
            const duration = parseInt(document.getElementById('sessionDuration').value);
            const capacity = parseInt(document.getElementById('sessionCapacity').value);
            const repeatWeeks = parseInt(document.getElementById('repeatWeeks').value);

            // Find the next occurrence of the selected day
            const today = new Date();
            let nextDate = new Date(today);

            // Calculate days until the next occurrence
            const currentDay = today.getDay();
            let daysUntil = dayOfWeek - currentDay;
            if (daysUntil <= 0) {
                daysUntil += 7;
            }
            nextDate.setDate(today.getDate() + daysUntil);

            // Create sessions for each week
            for (let i = 0; i < repeatWeeks; i++) {
                const sessionDate = new Date(nextDate);
                sessionDate.setDate(nextDate.getDate() + (i * 7));

                const dateStr = sessionDate.toISOString().split('T')[0];

                createSession({
                    sessionType: sessionType,
                    date: dateStr,
                    time: time,
                    duration: duration,
                    capacity: capacity
                });
            }

            alert(`Created ${repeatWeeks} session(s)!`);
            document.getElementById('create-session-form').reset();
            document.getElementById('sessionTime').value = '19:00';
            document.getElementById('sessionDuration').value = '60';
            document.getElementById('sessionCapacity').value = '4';
            document.getElementById('repeatWeeks').value = '1';
            loadHostSessions();
        });

        // Add Person Modal
        let selectedHostSessionId = null;

        function openAddPersonModal(sessionId) {
            selectedHostSessionId = sessionId;
            const session = getSessionById(sessionId);

            if (!session) return;

            if (session.bookings.length >= session.capacity) {
                alert('This session is already full!');
                return;
            }

            const date = new Date(session.date + 'T' + session.time);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            document.getElementById('add-session-details').innerHTML = `
                <p class="session-type-badge">${session.sessionType || 'Session'}</p>
                <p><strong>${dateStr}</strong></p>
                <p>${timeStr} - ${session.bookings.length}/${session.capacity} booked</p>
            `;

            document.getElementById('add-person-modal').classList.remove('hidden');
            document.getElementById('addFirstName').focus();
        }

        document.querySelector('#add-person-modal .close-btn').addEventListener('click', () => {
            document.getElementById('add-person-modal').classList.add('hidden');
            document.getElementById('add-person-form').reset();
        });

        document.getElementById('add-person-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const firstName = document.getElementById('addFirstName').value.trim();
            const lastName = document.getElementById('addLastName').value.trim();

            if (!firstName || !lastName) {
                alert('Please enter first and last name');
                return;
            }

            const success = addBooking(selectedHostSessionId, firstName, lastName);

            if (success) {
                document.getElementById('add-person-modal').classList.add('hidden');
                document.getElementById('add-person-form').reset();
                loadHostSessions();
            } else {
                alert('Could not add person. Session may be full.');
            }
        });

        function removeBooking(sessionId, bookingIndex) {
            if (confirm('Remove this person from the session?')) {
                removeBookingFromSession(sessionId, bookingIndex);
                loadHostSessions();
            }
        }

        function deleteSession(sessionId) {
            const session = getSessionById(sessionId);
            if (session && session.bookings.length > 0) {
                if (!confirm('This session has bookings. Are you sure you want to delete it?')) {
                    return;
                }
            } else if (!confirm('Delete this session?')) {
                return;
            }

            deleteSessionById(sessionId);
            loadHostSessions();
        }

        // Close modal on outside click
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
                document.getElementById('add-person-form').reset();
            }
        });
    </script>
</body>
</html>
