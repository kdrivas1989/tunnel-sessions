<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunnel Sessions - Host Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="shredclub-logo.png" alt="Shred Club Logo" class="logo-png">
            <h1>Host Dashboard</h1>
            <p class="tagline">Manage Your Sessions</p>
        </header>

        <!-- Login Screen -->
        <main id="login-screen" class="host-main">
            <section class="card login-card">
                <h2>Host Login</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label for="loginUsername">Email</label>
                        <input type="email" id="loginUsername" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required autocomplete="current-password">
                    </div>
                    <p id="login-error" class="error-message hidden">Invalid email or password</p>
                    <button type="submit" class="btn btn-primary btn-full">Login</button>
                </form>
            </section>
        </main>

        <!-- Setup Screen (First Time) -->
        <main id="setup-screen" class="host-main hidden">
            <section class="card login-card">
                <h2>Create Admin Account</h2>
                <p class="setup-intro">Set up your host login to manage sessions.</p>
                <form id="setup-form">
                    <div class="form-group">
                        <label for="setupUsername">Email</label>
                        <input type="email" id="setupUsername" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label for="setupPassword">Password</label>
                        <input type="password" id="setupPassword" required minlength="6" autocomplete="new-password">
                        <p class="field-hint">Minimum 6 characters</p>
                    </div>
                    <div class="form-group">
                        <label for="setupPasswordConfirm">Confirm Password</label>
                        <input type="password" id="setupPasswordConfirm" required minlength="6" autocomplete="new-password">
                    </div>
                    <p id="setup-error" class="error-message hidden"></p>
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                </form>
            </section>
        </main>

        <!-- Dashboard (After Login) -->
        <main id="dashboard-screen" class="host-main hidden">
            <!-- Logout Bar -->
            <div class="logout-bar">
                <span id="welcome-user"></span>
                <div class="logout-actions">
                    <button class="btn btn-small btn-outline" onclick="openChangePasswordModal()">Change Password</button>
                    <button class="btn btn-small btn-outline" onclick="handleLogout()">Logout</button>
                </div>
            </div>

            <!-- Create Session Section -->
            <section class="card">
                <h2>Create New Session</h2>
                <form id="create-session-form">
                    <div class="form-group">
                        <label for="sessionType">Session Type</label>
                        <select id="sessionType" required>
                            <option value="">Select a session type</option>
                            <option value="ShredClub">ShredClub</option>
                            <option value="Rookie Scrambles">Rookie Scrambles</option>
                            <option value="Advanced Scrambles">Advanced Scrambles</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sessionDate">Date</label>
                            <input type="date" id="sessionDate" required>
                        </div>
                        <div class="form-group">
                            <label for="sessionTime">Time</label>
                            <select id="sessionTime" required>
                                <option value="">Select a date first</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sessionDuration">Duration (minutes)</label>
                            <input type="number" id="sessionDuration" value="60" min="15" max="180" required>
                        </div>
                        <div class="form-group">
                            <label for="sessionCapacity">Capacity (people)</label>
                            <input type="number" id="sessionCapacity" value="4" min="1" max="20" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="repeatWeeks">Repeat for X weeks</label>
                            <input type="number" id="repeatWeeks" value="1" min="1" max="52" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Create Session(s)</button>
                </form>
            </section>

            <!-- Manage Sessions Section -->
            <section class="card">
                <h2>Manage Sessions</h2>
                <div id="host-sessions-list" class="host-sessions"></div>
                <div id="no-host-sessions" class="message hidden">
                    <p>No sessions created yet. Create your first session above!</p>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="card">
                <h2>Auto-Text Settings</h2>
                <form id="settings-form">
                    <div class="form-group">
                        <label for="autoTextPhones">Phone Numbers for Daily Texts</label>
                        <textarea id="autoTextPhones" rows="3" placeholder="Enter phone numbers, one per line&#10;e.g.&#10;9784917053&#10;5551234567" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                        <p class="field-hint">One number per line. Texts sent daily at 12pm with participant lists.</p>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                    <span id="settings-saved" class="success-message hidden" style="margin-left: 10px;">Saved!</span>
                </form>
            </section>

            <!-- Host Management Section (Admin Only) -->
            <section id="host-management" class="card hidden">
                <h2>Manage Hosts (Admin Only)</h2>
                <form id="create-host-form" style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newHostEmail">Host Email</label>
                            <input type="email" id="newHostEmail" required placeholder="host@example.com">
                        </div>
                        <div class="form-group">
                            <label for="newHostPassword">Password</label>
                            <input type="password" id="newHostPassword" required minlength="6" placeholder="Min 6 characters">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Host</button>
                    <span id="host-created" class="success-message hidden" style="margin-left: 10px;">Host created!</span>
                    <span id="host-error" class="error-message hidden" style="margin-left: 10px;"></span>
                </form>
                <div id="hosts-list"></div>
            </section>

            <!-- User Management Section (Admin Only) -->
            <section id="user-management" class="card hidden">
                <h2>Manage Users (Admin Only)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">All registered users who can book sessions.</p>
                <div id="users-list"></div>
            </section>

            <!-- Password Reset Requests (Admin Only) -->
            <section id="reset-requests" class="card hidden">
                <h2>Password Reset Requests</h2>
                <div id="reset-requests-list"></div>
            </section>

            <!-- Add Person Modal -->
            <div id="add-person-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h3>Add Person to Session</h3>
                    <div id="add-session-details"></div>
                    <form id="add-person-form">
                        <div class="form-group">
                            <label for="addFirstName">First Name</label>
                            <input type="text" id="addFirstName" required>
                        </div>
                        <div class="form-group">
                            <label for="addLastName">Last Name</label>
                            <input type="text" id="addLastName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Person</button>
                    </form>
                </div>
            </div>

            <!-- Change Password Modal -->
            <div id="change-password-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h3>Change Password</h3>
                    <form id="change-password-form">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" required autocomplete="current-password">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" required minlength="6" autocomplete="new-password">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" required minlength="6" autocomplete="new-password">
                        </div>
                        <p id="change-password-error" class="error-message hidden"></p>
                        <p id="change-password-success" class="success-message hidden">Password changed successfully!</p>
                        <button type="submit" class="btn btn-primary btn-full">Update Password</button>
                    </form>
                </div>
            </div>

            <!-- Edit Session Modal -->
            <div id="edit-session-modal" class="modal hidden">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h3>Edit Session</h3>
                    <div id="edit-session-details"></div>
                    <form id="edit-session-form">
                        <div class="form-group">
                            <label for="editSessionType">Session Type</label>
                            <select id="editSessionType" required>
                                <option value="ShredClub">ShredClub</option>
                                <option value="Rookie Scrambles">Rookie Scrambles</option>
                                <option value="Advanced Scrambles">Advanced Scrambles</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">Save Changes</button>
                    </form>
                </div>
            </div>
        </main>

        <footer>
            <a href="index.html" class="host-link">Back to Booking Page</a>
        </footer>
    </div>

    <script src="app.js?v=4"></script>
    <script>
        // Screen management
        const loginScreen = document.getElementById('login-screen');
        const setupScreen = document.getElementById('setup-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');

        function showScreen(screen) {
            loginScreen.classList.add('hidden');
            setupScreen.classList.add('hidden');
            dashboardScreen.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        // Initialize - check auth state
        document.addEventListener('DOMContentLoaded', () => {
            if (!adminExists()) {
                // First time - show setup
                showScreen(setupScreen);
            } else if (isLoggedIn()) {
                // Already logged in
                showDashboard();
            } else {
                // Show login
                showScreen(loginScreen);
            }
        });

        // Setup form
        document.getElementById('setup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('setupUsername').value.trim();
            const password = document.getElementById('setupPassword').value;
            const confirmPassword = document.getElementById('setupPasswordConfirm').value;
            const errorEl = document.getElementById('setup-error');

            errorEl.classList.add('hidden');

            if (!username || username.length < 3) {
                errorEl.textContent = 'Username must be at least 3 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                createAdmin(username, password);
                setLoggedIn();
                showDashboard();
            } catch (err) {
                errorEl.textContent = 'Error creating account: ' + err.message;
                errorEl.classList.remove('hidden');
                console.error('Setup error:', err);
            }
        });

        // Login form - accepts host OR admin
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('login-error');

            // Try host login first
            let valid = false;
            const host = verifyHost(email, password);
            if (host) {
                valid = true;
                sessionStorage.setItem('hostRole', 'host');
            }

            // If not host, try admin login
            if (!valid) {
                const isAdmin = verifyAdmin(email, password);
                if (isAdmin) {
                    valid = true;
                    sessionStorage.setItem('hostRole', 'admin');
                }
            }

            if (valid) {
                errorEl.classList.add('hidden');
                setLoggedIn();
                showDashboard();
            } else {
                errorEl.classList.remove('hidden');
            }
        });

        // Logout
        function handleLogout() {
            logout();
            sessionStorage.removeItem('hostRole');
            showScreen(loginScreen);
            document.getElementById('login-form').reset();
        }

        // Show dashboard
        function showDashboard() {
            const role = sessionStorage.getItem('hostRole') || 'host';
            const admin = getAdmin();

            if (role === 'admin' && admin) {
                document.getElementById('welcome-user').textContent = `Welcome, ${admin.username} (Admin)`;
                document.getElementById('host-management').classList.remove('hidden');
                document.getElementById('user-management').classList.remove('hidden');
                document.getElementById('reset-requests').classList.remove('hidden');
                loadHosts();
                loadUsers();
                loadResetRequests();
            } else {
                document.getElementById('welcome-user').textContent = `Welcome, Host`;
                document.getElementById('host-management').classList.add('hidden');
                document.getElementById('user-management').classList.add('hidden');
                document.getElementById('reset-requests').classList.add('hidden');
            }

            showScreen(dashboardScreen);
            loadHostSessions();
            loadSettings();

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').min = today;
        }

        // Load and display hosts (admin only)
        function loadHosts() {
            const hosts = getHosts();
            const container = document.getElementById('hosts-list');

            if (hosts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No hosts created yet.</p>';
                return;
            }

            let html = '<ul class="bookings-list">';
            hosts.forEach(host => {
                html += `
                    <li>
                        <span>${host.email}</span>
                        <button class="btn-remove" onclick="removeHost('${host.id}')">Remove</button>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Remove host
        function removeHost(hostId) {
            if (confirm('Are you sure you want to remove this host?')) {
                deleteHost(hostId);
                loadHosts();
            }
        }

        // Create host form
        document.getElementById('create-host-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('newHostEmail').value.trim();
            const password = document.getElementById('newHostPassword').value;
            const successEl = document.getElementById('host-created');
            const errorEl = document.getElementById('host-error');

            successEl.classList.add('hidden');
            errorEl.classList.add('hidden');

            if (password.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            const result = createHost(email, password);

            if (result.success) {
                successEl.classList.remove('hidden');
                document.getElementById('create-host-form').reset();
                loadHosts();
                setTimeout(() => successEl.classList.add('hidden'), 2000);
            } else {
                errorEl.textContent = result.error;
                errorEl.classList.remove('hidden');
            }
        });

        // Load and display users (admin only)
        function loadUsers() {
            const users = getUsers();
            const container = document.getElementById('users-list');

            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No users registered yet.</p>';
                return;
            }

            let html = '<ul class="bookings-list">';
            users.forEach(user => {
                const hasSecretary = user.permissions && user.permissions.includes('secretary');
                const permissionBadge = hasSecretary
                    ? '<span style="background: var(--secondary-color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">Secretary</span>'
                    : '';

                html += `
                    <li style="flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong>${user.firstName} ${user.lastName}</strong>${permissionBadge}<br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">${user.email}</span>
                        </div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-small ${hasSecretary ? 'btn-danger' : 'btn-primary'}" onclick="toggleSecretaryPermission('${user.id}')">
                                ${hasSecretary ? 'Remove Secretary' : 'Make Secretary'}
                            </button>
                            <button class="btn btn-small btn-edit" onclick="resetUserPassword('${user.id}')">Reset Password</button>
                            <button class="btn-remove" onclick="removeUser('${user.id}')">Remove</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Toggle secretary permission
        function toggleSecretaryPermission(userId) {
            const users = getUsers();
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const currentPerms = user.permissions || [];
            const hasSecretary = currentPerms.includes('secretary');

            if (hasSecretary) {
                updateUserPermissions(userId, currentPerms.filter(p => p !== 'secretary'));
            } else {
                updateUserPermissions(userId, [...currentPerms, 'secretary']);
            }

            loadUsers();
        }

        // Reset user password
        function resetUserPassword(userId) {
            const newPassword = prompt('Enter new password for this user (min 6 characters):');
            if (!newPassword) return;

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            const users = getUsers();
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                alert('User not found');
                return;
            }

            users[userIndex].passwordHash = hashPassword(newPassword);
            saveUsers(users);
            alert('Password reset successfully');
        }

        // Remove user
        function removeUser(userId) {
            if (!confirm('Are you sure you want to remove this user?')) return;

            const users = getUsers();
            const filtered = users.filter(u => u.id !== userId);
            saveUsers(filtered);
            loadUsers();
        }

        // Load password reset requests
        function loadResetRequests() {
            const requests = JSON.parse(localStorage.getItem('tunnelSessionsResetRequests') || '[]');
            const pendingRequests = requests.filter(r => !r.processed);
            const container = document.getElementById('reset-requests-list');

            if (pendingRequests.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No pending password reset requests.</p>';
                return;
            }

            let html = '<ul class="bookings-list">';
            pendingRequests.forEach(request => {
                const requestDate = new Date(request.requestedAt).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                html += `
                    <li style="flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong>${request.userName}</strong><br>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">${request.email}</span><br>
                            <span style="color: var(--text-secondary); font-size: 0.8rem;">Requested: ${requestDate}</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-small btn-primary" onclick="processResetRequest('${request.id}')">Reset Password</button>
                            <button class="btn-remove" onclick="dismissResetRequest('${request.id}')">Dismiss</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            container.innerHTML = html;
        }

        // Process reset request - reset the user's password
        function processResetRequest(requestId) {
            const requests = JSON.parse(localStorage.getItem('tunnelSessionsResetRequests') || '[]');
            const request = requests.find(r => r.id === requestId);

            if (!request) {
                alert('Request not found');
                return;
            }

            const newPassword = prompt(`Enter new password for ${request.userName} (${request.email}):`);
            if (!newPassword) return;

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            // Find and update user
            const users = getUsers();
            const userIndex = users.findIndex(u => u.email.toLowerCase() === request.email.toLowerCase());

            if (userIndex === -1) {
                alert('User not found');
                return;
            }

            users[userIndex].passwordHash = hashPassword(newPassword);
            saveUsers(users);

            // Mark request as processed
            request.processed = true;
            request.processedAt = new Date().toISOString();
            localStorage.setItem('tunnelSessionsResetRequests', JSON.stringify(requests));

            alert(`Password reset for ${request.userName}. Please inform them their new password is: ${newPassword}`);
            loadResetRequests();
        }

        // Dismiss reset request
        function dismissResetRequest(requestId) {
            if (!confirm('Dismiss this reset request?')) return;

            const requests = JSON.parse(localStorage.getItem('tunnelSessionsResetRequests') || '[]');
            const request = requests.find(r => r.id === requestId);

            if (request) {
                request.processed = true;
                request.dismissed = true;
                localStorage.setItem('tunnelSessionsResetRequests', JSON.stringify(requests));
            }

            loadResetRequests();
        }

        // Settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('tunnelSessionsSettings') || '{}');
            // Support both old single phone and new multiple phones format
            if (settings.autoTextPhones) {
                document.getElementById('autoTextPhones').value = settings.autoTextPhones.join('\n');
            } else if (settings.autoTextPhone) {
                document.getElementById('autoTextPhones').value = settings.autoTextPhone;
            } else {
                document.getElementById('autoTextPhones').value = '9784917053';
            }
        }

        function saveSettings() {
            const phonesText = document.getElementById('autoTextPhones').value;
            // Parse phone numbers: split by newlines/commas, clean each, filter empty
            const phones = phonesText
                .split(/[\n,]+/)
                .map(p => p.replace(/\D/g, '').trim())
                .filter(p => p.length >= 10);

            const settings = {
                autoTextPhones: phones,
                autoTextPhone: phones[0] || '' // Keep for backwards compatibility
            };
            localStorage.setItem('tunnelSessionsSettings', JSON.stringify(settings));
        }

        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveSettings();
            document.getElementById('settings-saved').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('settings-saved').classList.add('hidden');
            }, 2000);
        });

        // Time picker based on date selection
        document.getElementById('sessionDate').addEventListener('change', updateTimeOptions);

        function updateTimeOptions() {
            const dateInput = document.getElementById('sessionDate');
            const timeSelect = document.getElementById('sessionTime');
            const dateValue = dateInput.value;

            timeSelect.innerHTML = '';

            if (!dateValue) {
                timeSelect.innerHTML = '<option value="">Select a date first</option>';
                return;
            }

            // Get day of week from selected date (0 = Sunday, 1 = Monday, etc.)
            const selectedDate = new Date(dateValue + 'T12:00:00');
            const day = selectedDate.getDay();

            // Check if it's a valid business day (Wed-Sun)
            // Monday = 1, Tuesday = 2 (closed)
            if (day === 1 || day === 2) {
                timeSelect.innerHTML = '<option value="">Closed on Mon/Tue - pick another date</option>';
                return;
            }

            let startHour, startMin, endHour, endMin;

            // Wednesday (3), Thursday (4), Friday (5): 2:00 PM - 9:00 PM
            // Saturday (6), Sunday (0): 10:00 AM - 5:30 PM
            if (day === 3 || day === 4 || day === 5) {
                startHour = 14; // 2:00 PM
                startMin = 0;
                endHour = 21;   // 9:00 PM
                endMin = 0;
            } else {
                startHour = 10; // 10:00 AM
                startMin = 0;
                endHour = 17;   // 5:30 PM
                endMin = 30;
            }

            // Generate 30-minute increments
            let hour = startHour;
            let min = startMin;

            while (hour < endHour || (hour === endHour && min <= endMin)) {
                const timeValue = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayTime = `${displayHour}:${min.toString().padStart(2, '0')} ${ampm}`;

                const option = document.createElement('option');
                option.value = timeValue;
                option.textContent = displayTime;
                timeSelect.appendChild(option);

                // Add 30 minutes
                min += 30;
                if (min >= 60) {
                    min = 0;
                    hour++;
                }
            }
        }

        function loadHostSessions() {
            const sessions = getSessions();
            const container = document.getElementById('host-sessions-list');
            const noSessionsMsg = document.getElementById('no-host-sessions');

            container.innerHTML = '';

            if (sessions.length === 0) {
                noSessionsMsg.classList.remove('hidden');
                container.classList.add('hidden');
                return;
            }

            noSessionsMsg.classList.add('hidden');
            container.classList.remove('hidden');

            // Sort by date
            sessions.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.time);
                const dateB = new Date(b.date + 'T' + b.time);
                return dateA - dateB;
            });

            sessions.forEach(session => {
                const card = createHostSessionCard(session);
                container.appendChild(card);
            });
        }

        function createHostSessionCard(session) {
            const card = document.createElement('div');
            card.className = 'host-session-card';

            const date = new Date(session.date + 'T' + session.time);
            const now = new Date();
            const isPast = date < now;

            if (isPast) {
                card.classList.add('past');
            }

            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const badgeClass = getSessionTypeClass(session.sessionType);

            let bookingsHtml = '';
            if (session.bookings.length > 0) {
                bookingsHtml = '<ul class="bookings-list">';
                session.bookings.forEach((booking, index) => {
                    bookingsHtml += `
                        <li>
                            <span>${booking.firstName} ${booking.lastName}</span>
                            <button class="btn-remove" onclick="removeBooking('${session.id}', ${index})" title="Remove">&#10005;</button>
                        </li>
                    `;
                });
                bookingsHtml += '</ul>';
            } else {
                bookingsHtml = '<p class="no-bookings">No bookings yet</p>';
            }

            const hasBookings = session.bookings.length > 0;
            const textBtn = hasBookings && !isPast ? `<button class="btn btn-small btn-text" onclick="textParticipants('${session.id}')">Text List</button>` : '';
            const editBtn = !isPast ? `<button class="btn btn-small btn-edit" onclick="openEditSessionModal('${session.id}')">Edit</button>` : '';

            card.innerHTML = `
                <div class="host-session-header">
                    <div>
                        <span class="session-type-badge ${badgeClass}">${session.sessionType || 'Session'}</span>
                        <h3>${dateStr}</h3>
                        <p>${timeStr} - ${session.duration} min | ${session.bookings.length}/${session.capacity} booked</p>
                    </div>
                    <div class="session-actions">
                        ${editBtn}
                        ${textBtn}
                        ${!isPast ? `<button class="btn btn-small" onclick="openAddPersonModal('${session.id}')">Add Person</button>` : ''}
                        <button class="btn btn-small btn-danger" onclick="deleteSession('${session.id}')">Delete</button>
                    </div>
                </div>
                <div class="bookings-container">
                    <h4>Bookings:</h4>
                    ${bookingsHtml}
                </div>
            `;

            return card;
        }

        // Create Session Form
        document.getElementById('create-session-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const sessionType = document.getElementById('sessionType').value;
            const selectedDate = document.getElementById('sessionDate').value;
            const time = document.getElementById('sessionTime').value;
            const duration = parseInt(document.getElementById('sessionDuration').value);
            const capacity = parseInt(document.getElementById('sessionCapacity').value);
            const repeatWeeks = parseInt(document.getElementById('repeatWeeks').value);

            if (!time || time.includes('Closed') || time.includes('Select')) {
                alert('Please select a valid date and time');
                return;
            }

            // Create sessions for each week starting from selected date
            const startDate = new Date(selectedDate + 'T12:00:00');

            for (let i = 0; i < repeatWeeks; i++) {
                const sessionDate = new Date(startDate);
                sessionDate.setDate(startDate.getDate() + (i * 7));

                const dateStr = sessionDate.toISOString().split('T')[0];

                createSession({
                    sessionType: sessionType,
                    date: dateStr,
                    time: time,
                    duration: duration,
                    capacity: capacity
                });
            }

            alert(`Created ${repeatWeeks} session(s)!`);
            document.getElementById('create-session-form').reset();
            document.getElementById('sessionTime').innerHTML = '<option value="">Select a date first</option>';
            document.getElementById('sessionDuration').value = '60';
            document.getElementById('sessionCapacity').value = '4';
            document.getElementById('repeatWeeks').value = '1';
            loadHostSessions();
        });

        // Add Person Modal
        let selectedHostSessionId = null;

        function openAddPersonModal(sessionId) {
            selectedHostSessionId = sessionId;
            const session = getSessionById(sessionId);

            if (!session) return;

            if (session.bookings.length >= session.capacity) {
                alert('This session is already full!');
                return;
            }

            const date = new Date(session.date + 'T' + session.time);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const badgeClass = getSessionTypeClass(session.sessionType);

            document.getElementById('add-session-details').innerHTML = `
                <p class="session-type-badge ${badgeClass}">${session.sessionType || 'Session'}</p>
                <p><strong>${dateStr}</strong></p>
                <p>${timeStr} - ${session.bookings.length}/${session.capacity} booked</p>
            `;

            document.getElementById('add-person-modal').classList.remove('hidden');
            document.getElementById('addFirstName').focus();
        }

        document.querySelector('#add-person-modal .close-btn').addEventListener('click', () => {
            document.getElementById('add-person-modal').classList.add('hidden');
            document.getElementById('add-person-form').reset();
        });

        document.getElementById('add-person-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const firstName = document.getElementById('addFirstName').value.trim();
            const lastName = document.getElementById('addLastName').value.trim();

            if (!firstName || !lastName) {
                alert('Please enter first and last name');
                return;
            }

            const success = addBooking(selectedHostSessionId, firstName, lastName);

            if (success) {
                document.getElementById('add-person-modal').classList.add('hidden');
                document.getElementById('add-person-form').reset();
                loadHostSessions();
            } else {
                alert('Could not add person. Session may be full.');
            }
        });

        function removeBooking(sessionId, bookingIndex) {
            if (confirm('Remove this person from the session?')) {
                removeBookingFromSession(sessionId, bookingIndex);
                loadHostSessions();
            }
        }

        function deleteSession(sessionId) {
            const session = getSessionById(sessionId);
            if (session && session.bookings.length > 0) {
                if (!confirm('This session has bookings. Are you sure you want to delete it?')) {
                    return;
                }
            } else if (!confirm('Delete this session?')) {
                return;
            }

            deleteSessionById(sessionId);
            loadHostSessions();
        }

        // Edit Session Modal
        let editingSessionId = null;

        function openEditSessionModal(sessionId) {
            editingSessionId = sessionId;
            const session = getSessionById(sessionId);

            if (!session) return;

            const date = new Date(session.date + 'T' + session.time);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            document.getElementById('edit-session-details').innerHTML = `
                <p><strong>${dateStr}</strong></p>
                <p>${timeStr} - ${session.bookings.length} participant(s)</p>
            `;

            document.getElementById('editSessionType').value = session.sessionType || 'ShredClub';
            document.getElementById('edit-session-modal').classList.remove('hidden');
        }

        document.querySelector('#edit-session-modal .close-btn').addEventListener('click', () => {
            document.getElementById('edit-session-modal').classList.add('hidden');
        });

        document.getElementById('edit-session-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const newSessionType = document.getElementById('editSessionType').value;

            if (editingSessionId && newSessionType) {
                updateSession(editingSessionId, { sessionType: newSessionType });
                document.getElementById('edit-session-modal').classList.add('hidden');
                loadHostSessions();
            }
        });

        // Text participants list
        function textParticipants(sessionId) {
            const session = getSessionById(sessionId);
            if (!session || session.bookings.length === 0) {
                alert('No participants to text');
                return;
            }

            const date = new Date(session.date + 'T' + session.time);
            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'short',
                day: 'numeric'
            });
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            // Build participant list
            const names = session.bookings.map(b => `${b.firstName} ${b.lastName}`).join(', ');

            // Build message
            const message = `${session.sessionType} - ${dateStr} at ${timeStr}\n\nParticipants:\n${session.bookings.map(b => `- ${b.firstName} ${b.lastName}`).join('\n')}`;

            // Phone number
            const phoneNumber = '9784917053';

            // Open SMS
            const smsUrl = `sms:${phoneNumber}&body=${encodeURIComponent(message)}`;
            window.open(smsUrl, '_self');
        }

        // Close modal on outside click
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.add('hidden');
                document.getElementById('add-person-form').reset();
                document.getElementById('change-password-form').reset();
                document.getElementById('change-password-error').classList.add('hidden');
                document.getElementById('change-password-success').classList.add('hidden');
            }
        });

        // Change Password Modal
        function openChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('hidden');
            document.getElementById('currentPassword').focus();
        }

        document.querySelector('#change-password-modal .close-btn').addEventListener('click', () => {
            document.getElementById('change-password-modal').classList.add('hidden');
            document.getElementById('change-password-form').reset();
            document.getElementById('change-password-error').classList.add('hidden');
            document.getElementById('change-password-success').classList.add('hidden');
        });

        document.getElementById('change-password-form').addEventListener('submit', (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const errorEl = document.getElementById('change-password-error');
            const successEl = document.getElementById('change-password-success');

            errorEl.classList.add('hidden');
            successEl.classList.add('hidden');

            if (newPassword !== confirmNewPassword) {
                errorEl.textContent = 'New passwords do not match';
                errorEl.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                errorEl.textContent = 'New password must be at least 6 characters';
                errorEl.classList.remove('hidden');
                return;
            }

            const success = changePassword(currentPassword, newPassword);

            if (success) {
                successEl.classList.remove('hidden');
                document.getElementById('change-password-form').reset();
                setTimeout(() => {
                    document.getElementById('change-password-modal').classList.add('hidden');
                    successEl.classList.add('hidden');
                }, 1500);
            } else {
                errorEl.textContent = 'Current password is incorrect';
                errorEl.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
